package kr.or.ddit.groupware.service.rental;

import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.List;

import javax.inject.Inject;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import kr.or.ddit.groupware.mapper.notification.INotificationMapper;
import kr.or.ddit.groupware.mapper.rental.IRentalMapper;
import kr.or.ddit.groupware.util.NotificationUtil;
import kr.or.ddit.groupware.util.Result;
import kr.or.ddit.groupware.vo.EmpAuthorityVO;
import kr.or.ddit.groupware.vo.NotificationVO;
import kr.or.ddit.groupware.vo.PaginationInfoVO;
import kr.or.ddit.groupware.vo.RentalVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class RentalServiceImpl implements IRentalService {

	@Inject
	private INotificationMapper notiMapper;
	@Inject
	private NotificationUtil notiUtill;
	@Autowired
	private IRentalMapper rentalMapper;

	public Result RentVehicle(RentalVO rentalVO) {
		Result res = null;

		int cnt = rentalMapper.rentVehicle(rentalVO);

		// 알림 받을 vo객체 준비
		if (cnt > 0) {
			notiRentVehicle(rentalVO);

			res = Result.OK;
		}
		else {
			{
				res = Result.FAILED;
			}
		}
		return res;
	}

	private void notiRentVehicle(RentalVO rentalVO) {
		EmpAuthorityVO empAuthVO = new EmpAuthorityVO();
		empAuthVO.setAuthorNm("ROLE_ADMIN"); // Assuming there's a setter method to set the authority name
		List<Integer> adminEmpNos = getAdminEmployeeNumbers(empAuthVO);

		for (int emplNo : adminEmpNos) {
			NotificationVO notificationVO = new NotificationVO();
			notificationVO.setNtcnRecp(emplNo);
			notificationVO.setNtcnTypeCode("N114");
			String content = "차량 대여 신청이 있습니다. 대여신청 번호: " + rentalVO.getErntNo();
			notificationVO.setNtcnContent(content);
			notificationVO.setNtcnUrl("/admin/rental/approval");
			notificationVO.setLocalDt(ZonedDateTime.now(ZoneId.of("Asia/Seoul")).toLocalDateTime());

			notiMapper.insertNotification(notificationVO);
		}
	}

	private List<Integer> getAdminEmployeeNumbers(EmpAuthorityVO empAuthVO) {
		return rentalMapper.findEmployeesByAuthority(empAuthVO);
	}

	@Override
	public Result RentSupplies(RentalVO rentalVO) {
		Result res = null;
		notiRentSupplies(rentalVO);
		int cnt = rentalMapper.rentSupplies(rentalVO);

		if (cnt > 0) {
			res = Result.OK;

		}
		else {
			{
				res = Result.FAILED;
			}
		}
		return res;
	}

	private void notiRentSupplies(RentalVO rentalVO) {
		EmpAuthorityVO empAuthVO = new EmpAuthorityVO();
		empAuthVO.setAuthorNm("ROLE_ADMIN"); // Assuming there's a setter method to set the authority name
		List<Integer> adminEmpNos = getAdminEmployeeNumbers(empAuthVO);
		for (int emplNo : adminEmpNos) {
			NotificationVO notificationVO = new NotificationVO();
			notificationVO.setNtcnRecp(emplNo); // 예약자에게 알림
			notificationVO.setNtcnTypeCode("N114"); // 알림 유형 코드
			String content = "비품 대여 신청이 있습니다. 대여신청 번호: " + rentalVO.getErntNo();
			notificationVO.setNtcnContent(content);
			notificationVO.setNtcnUrl("/admin/rental/returnList"); // 예약 세부정보 페이지 URL
			notificationVO.setLocalDt(ZonedDateTime.now(ZoneId.of("Asia/Seoul")).toLocalDateTime());

			notiMapper.insertNotification(notificationVO); // 알림 DB에 저장
		}
	}

	@Override
	public List<RentalVO> getReservationsByResourceType(RentalVO rentalVO) {
		return rentalMapper.findRentalByResourceType(rentalVO);
	}

	@Override
	public boolean isRentalPossible(RentalVO rentalVO) {

		List<RentalVO> conflicts = rentalMapper.findOverlappingRentals(rentalVO.getEqpnmCd(), rentalVO.getErntBeginDt(),
				rentalVO.getErntEndDt());
		return conflicts.size() == 0;
	}

	@Override
	public boolean deleteRentalVehicle(RentalVO rentalVO) {
		return rentalMapper.cancleRentalVehicle(rentalVO);
	}

	@Override
	public boolean deleteRentalSupplies(RentalVO rentalVO) {
		return rentalMapper.cancleRentalSupplies(rentalVO);

	}

	@Override
	public int selectRentalCount(PaginationInfoVO<RentalVO> pagingVO) {
		return rentalMapper.selectRentalCount(pagingVO);
	}

	@Override
	public List<RentalVO> selectRentalList(PaginationInfoVO<RentalVO> pagingVO) {
		return rentalMapper.selectRentalList(pagingVO);
	}

	@Override
	public Result approveRental(int erntNo) {
		int affectedRows = rentalMapper.approveRental(erntNo);
		if (affectedRows > 0) {
			return Result.OK; // Approval was successful
		}
		else {
			return Result.FAILED; // Approval failed, no rows were updated
		}
	}

	@Override
	public Result rejectRental(int erntNo) {
		int affectedRows = rentalMapper.rejectRental(erntNo);
		if (affectedRows > 0) {
			return Result.OK; // Approval was successful
		}
		else {
			return Result.FAILED; // Approval failed, no rows were updated
		}
	}

}
